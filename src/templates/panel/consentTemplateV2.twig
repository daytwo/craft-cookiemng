<script>
    // Define dataLayer and the gtag function.
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    let cmEventSequence = 0;
    const cmNextEventId = () => {
        cmEventSequence += 1;
        return 'cm-' + Date.now().toString(36) + '-' + cmEventSequence;
    };

    const cmEnsureDataLayer = () => {
        if (typeof window.dataLayer === 'undefined') {
            window.dataLayer = [];
        }
        return window.dataLayer;
    };
    
    {% if settings.getCookieGoogleEnabled(siteHandle) %}
        let consent = {
            'ad_storage': '{{"advertising" in permissions ? 'granted' : 'denied'}}', //advertising
            'ad_user_data': '{{"advertising" in permissions ? 'granted' : 'denied'}}', //advertising
            'ad_personalization': '{{"personalization" in permissions ? 'granted' : 'denied'}}', //personalization
            'personalization_storage': '{{"personalization" in permissions ? 'granted' : 'denied'}}', //personalization
            'analytics_storage': '{{"analytics" in permissions ? 'granted' : 'denied'}}', //analytics
            'functionality_storage': 'granted', //functional
            'security_storage': 'granted' //functional
        };
        
        {% if settings.getExtraCookies(siteHandle) %}
            consent['{{settings.getExtraCookieProperty(siteHandle)}}'] = "{{settings.getExtraCookieProperty(siteHandle) in permissions ? 'granted' : 'denied'}}";
        {% endif %}
        
        gtag('consent', 'default', consent);

    {% endif %}
    window.cmSyncConsentState = function(granted, denied, source){
        const grantList = Array.from(new Set(['functional'].concat(granted || [])));
        const denyList = Array.from(new Set((denied || []).filter((value)=>grantList.indexOf(value) === -1)));
        const normalizedGranted = grantList.slice().sort();
        const normalizedDenied = denyList.slice().sort();
        window.cmConsentState = {
            granted: normalizedGranted,
            denied: normalizedDenied,
            signature: normalizedGranted.join('|') + '::' + normalizedDenied.join('|'),
            source: source,
            lastUpdated: Date.now()
        };
        window.cmGetConsentState = function(){
            return window.cmConsentState || {granted: [], denied: []};
        };
        return window.cmConsentState;
    };

    let cm_updateConsent = (granted,denied) => {
        {% if not settings.getCookieGoogleEnabled(siteHandle) %}
            return;
        {% endif %}
        let consent_list = {};
        granted.forEach((prop)=>{
            switch (prop){
                case 'functional':
                    consent_list['functionality_storage'] = 'granted'    
                    consent_list['security_storage'] = 'granted'
                    break;
                case 'analytics':
                    consent_list['analytics_storage'] = 'granted'
                    break;
                case 'advertising':
                    consent_list['ad_storage'] = 'granted'
                    consent_list['ad_user_data'] = 'granted'
                    break;
                case 'personalization':
                    consent_list['personalization_storage'] = 'granted'
                    consent_list['ad_personalization'] = 'granted'
                    break;
                {% if settings.getExtraCookies(siteHandle) %}
                    case '{{settings.getExtraCookieProperty(siteHandle)}}':
                        consent_list['{{settings.getExtraCookieProperty(siteHandle)}}'] = 'granted';
                        break;
                {% endif %}
            }
        });
        denied.forEach((prop)=>{
            switch (prop){
                case 'functional':
                    consent_list['functionality_storage'] = 'denied'    
                    consent_list['security_storage'] = 'denied'
                    break;
                case 'analytics':
                    consent_list['analytics_storage'] = 'denied'
                    break;
                case 'advertising':
                    consent_list['ad_storage'] = 'denied'
                    consent_list['ad_user_data'] = 'denied'
                    break;
                case 'personalization':
                    consent_list['personalization_storage'] = 'denied'
                    consent_list['ad_personalization'] = 'denied'
                    break;
                {% if settings.getExtraCookies(siteHandle) %}
                    case '{{settings.getExtraCookieProperty(siteHandle)}}':
                        consent_list['{{settings.getExtraCookieProperty(siteHandle)}}'] = 'denied';
                        break;
                {% endif %}
            }
        });
        let data = {};
        for (const [key, value] of Object.entries(consent_list)) {
            data[key] = value;
        }
        const state = window.cmSyncConsentState(granted, denied, 'user-action');
        cmEnsureDataLayer().push({
            event: 'cm_consent_applied',
            consentGranted: state.granted,
            consentDenied: state.denied,
            consent: data,
            eventSource: 'user-action',
            eventId: cmNextEventId()
        });
    }

    const cmInitialGranted = ['functional'];
    const cmInitialDenied = [];
    {% if settings.getAnalyticsCookies(siteHandle) %}
        {% if permissions is iterable and 'analytics' in permissions %}
            cmInitialGranted.push('analytics');
        {% else %}
            cmInitialDenied.push('analytics');
        {% endif %}
    {% endif %}
    {% if settings.getAdvertisingCookies(siteHandle) %}
        {% if permissions is iterable and 'advertising' in permissions %}
            cmInitialGranted.push('advertising');
        {% else %}
            cmInitialDenied.push('advertising');
        {% endif %}
    {% endif %}
    {% if settings.getPersonalizationCookies(siteHandle) %}
        {% if permissions is iterable and 'personalization' in permissions %}
            cmInitialGranted.push('personalization');
        {% else %}
            cmInitialDenied.push('personalization');
        {% endif %}
    {% endif %}
    {% if settings.getExtraCookies(siteHandle) %}
        {% set extraSlug = settings.getExtraCookieProperty(siteHandle) %}
        {% if permissions is iterable and settings.getExtraCookieProperty(siteHandle) in permissions %}
            cmInitialGranted.push('{{extraSlug}}');
            cmInitialGranted.push('custom_consent');
        {% else %}
            cmInitialDenied.push('{{extraSlug}}');
            cmInitialDenied.push('custom_consent');
        {% endif %}
    {% endif %}

    const cmInitialState = window.cmSyncConsentState(cmInitialGranted, cmInitialDenied, 'consent-script');
    cmEnsureDataLayer().push({
        event: 'cm_consent_ready',
        consentGranted: cmInitialState.granted,
        consentDenied: cmInitialState.denied,
        eventSource: 'initial-load',
        eventId: cmNextEventId()
    });
</script>